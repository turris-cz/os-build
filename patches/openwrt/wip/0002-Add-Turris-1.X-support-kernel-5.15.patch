From fc2fd9ae224450f539fed403820d87cace56962e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Karel=20Ko=C4=8D=C3=AD?= <karel.koci@nic.cz>
Date: Mon, 17 Feb 2020 11:56:15 +0100
Subject: [PATCH] Add Turris 1.X support (kernel 5.15)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Marek Behún <marek.behun@nic.cz>
Signed-off-by: Karel Kočí <karel.koci@nic.cz>
---
 package/boot/uboot-tools/files/mpc85xx     |   3 +
 .../mpc85xx/base-files/etc/board.d/02_network |   4 +
 target/linux/mpc85xx/config-5.15               |  65 ++-
 target/linux/mpc85xx/image/p2020.mk           |   9 +
 target/linux/mpc85xx/p2020/config-default     |  27 +
 6 files changed, 569 insertions(+), 6 deletions(-)
 create mode 100644 target/linux/mpc85xx/files/arch/powerpc/boot/dts/turris1x.dts

diff --git a/package/boot/uboot-tools/files/mpc85xx b/package/boot/uboot-tools/files/mpc85xx
index d219b57cb1..932a46af7b 100644
--- a/package/boot/uboot-tools/files/mpc85xx
+++ b/package/boot/uboot-tools/files/mpc85xx
@@ -10,6 +10,9 @@ touch /etc/config/ubootenv
 board=$(board_name)

 case "$board" in
+cznic,turris1x)
+	ubootenv_add_uci_config "/dev/mtd5" "0x20000" "0x2000" "0x20000"
+	;;
 extreme-networks,ws-ap3825i)
 	ubootenv_add_uci_config "$(find_mtd_part 'cfg1')" "0x0" "0x10000" "0x20000"
 	ubootenv_add_uci_config "$(find_mtd_part 'cfg2')" "0x0" "0x10000" "0x20000"
diff --git a/target/linux/mpc85xx/base-files/etc/board.d/02_network b/target/linux/mpc85xx/base-files/etc/board.d/02_network
index 7a677ee96f..68102e7f7c 100644
--- a/target/linux/mpc85xx/base-files/etc/board.d/02_network
+++ b/target/linux/mpc85xx/base-files/etc/board.d/02_network
@@ -21,6 +21,10 @@ tplink,tl-wdr4900-v1)
 	ucidef_set_interfaces_lan_wan "lan1 lan2 lan3 lan4" "wan"
 	ucidef_set_interface_macaddr "wan" "$(macaddr_add $(mtd_get_mac_binary u-boot 0x4fc00) 1)"
 	;;
+cznic,turris1x)
+	ucidef_set_interface_lan "lan1 lan2 lan3 lan4 lan5"
+	ucidef_set_interface_wan "eth2"
+	;;
 *)
 	ucidef_set_interfaces_lan_wan "eth0" "eth1"
 	;;
diff --git a/target/linux/mpc85xx/config-5.15 b/target/linux/mpc85xx/config-5.15
index 5700a247de..fa1307a79c 100644
--- a/target/linux/mpc85xx/config-5.15
+++ b/target/linux/mpc85xx/config-5.15
@@ -22,6 +22,15 @@ CONFIG_BOOKE=y
 CONFIG_BOOKE_WDT=y
 # CONFIG_BSC9131_RDB is not set
 # CONFIG_BSC9132_QDS is not set
+CONFIG_BTRFS_FS=y
+CONFIG_VFAT_FS=y
+CONFIG_FAT_DEFAULT_CODEPAGE=437
+CONFIG_FAT_DEFAULT_IOCHARSET="iso8859-1"
+CONFIG_NLS_CODEPAGE_437=y
+CONFIG_NLS_ISO8859_1=y
+# CONFIG_BTRFS_FS_CHECK_INTEGRITY is not set
+CONFIG_BTRFS_FS_POSIX_ACL=y
+CONFIG_BUILD_BIN2C=y
 # CONFIG_C293_PCIE is not set
 CONFIG_CLONE_BACKWARDS=y
 CONFIG_CLZ_TAB=y
@@ -36,6 +45,7 @@ CONFIG_CPU_BIG_ENDIAN=y
 # CONFIG_CRYPTO_AES_PPC_SPE is not set
 CONFIG_CRYPTO_AUTHENC=y
 CONFIG_CRYPTO_HW=y
+CONFIG_CRYPTO_LZO=y
 CONFIG_CRYPTO_LIB_BLAKE2S_GENERIC=y
 CONFIG_CRYPTO_LIB_POLY1305_RSIZE=1
 # CONFIG_CRYPTO_MD5_PPC is not set
@@ -110,6 +120,10 @@ CONFIG_IRQ_DOMAIN=y
 CONFIG_IRQ_FORCED_THREADING=y
 CONFIG_IRQ_WORK=y
 CONFIG_ISA_DMA_API=y
+CONFIG_JFFS2_FS_POSIX_ACL=y
+CONFIG_JFFS2_LZO=y
+CONFIG_JFFS2_RUBIN=y
+CONFIG_JFFS2_ZLIB=y
 CONFIG_KERNEL_START=0xc0000000
 # CONFIG_KSI8560 is not set
 CONFIG_LEGACY_PTYS=y
@@ -120,6 +134,13 @@ CONFIG_LOWMEM_CAM_NUM=3
 CONFIG_LOWMEM_SIZE=0x30000000
 CONFIG_LXT_PHY=y
 # CONFIG_MATH_EMULATION is not set
+CONFIG_LZO_COMPRESS=y
+CONFIG_LZO_DECOMPRESS=y
+CONFIG_HIGHMEM=y
+CONFIG_MATH_EMULATION=y
+# CONFIG_MATH_EMULATION_FULL is not set
+CONFIG_MATH_EMULATION_HW_UNIMPLEMENTED=y
+CONFIG_MDIO_BOARDINFO=y
 CONFIG_MDIO_BUS=y
 CONFIG_MDIO_DEVICE=y
 CONFIG_MDIO_DEVRES=y
@@ -138,12 +159,22 @@ CONFIG_MPIC=y
 # CONFIG_MPIC_MSGR is not set
 CONFIG_MPIC_TIMER=y
 CONFIG_MPILIB=y
-# CONFIG_MTD_CFI is not set
+CONFIG_MTD_CFI_STAA=y
+CONFIG_MTD_JEDECPROBE=y
 CONFIG_MTD_NAND_CORE=y
 CONFIG_MTD_NAND_ECC=y
 CONFIG_MTD_NAND_ECC_SW_HAMMING=y
 CONFIG_MTD_RAW_NAND=y
 CONFIG_MTD_SPI_NOR=y
+CONFIG_MTD_RAM=y
+CONFIG_MTD_ROM=y
+CONFIG_MTD_UBI=y
+CONFIG_MTD_UBI_BEB_LIMIT=20
+# CONFIG_MTD_UBI_BLOCK is not set
+# CONFIG_MTD_UBI_FASTMAP is not set
+# CONFIG_MTD_UBI_GLUEBI is not set
+CONFIG_MTD_UBI_WL_THRESHOLD=4096
+CONFIG_MUTEX_SPIN_ON_OWNER=y
 # CONFIG_MVME2500 is not set
 CONFIG_NEED_PER_CPU_KM=y
 CONFIG_NEED_SG_DMA_LENGTH=y
@@ -161,6 +192,7 @@ CONFIG_OF_GPIO=y
 CONFIG_OF_IRQ=y
 CONFIG_OF_KOBJ=y
 CONFIG_OF_MDIO=y
+CONFIG_OF_MTD=y
 CONFIG_OLD_SIGACTION=y
 CONFIG_OLD_SIGSUSPEND=y
 # CONFIG_P1010_RDB is not set
@@ -185,6 +217,8 @@ CONFIG_PHYSICAL_START=0x00000000
 # CONFIG_PHYS_64BIT is not set
 # CONFIG_PMU_SYSFS is not set
 # CONFIG_PPA8548 is not set
+CONFIG_NET_DSA=y
+CONFIG_NET_DSA_QCA8K=y
 CONFIG_PPC=y
 CONFIG_PPC32=y
 # CONFIG_PPC64 is not set
@@ -196,12 +230,14 @@ CONFIG_PPC_ADV_DEBUG_IACS=2
 CONFIG_PPC_ADV_DEBUG_REGS=y
 CONFIG_PPC_BARRIER_NOSPEC=y
 CONFIG_PPC_BOOK3E_MMU=y
+CONFIG_PPC_I8259=y
 # CONFIG_PPC_BOOK3S_32 is not set
 CONFIG_PPC_DOORBELL=y
 # CONFIG_PPC_E500MC is not set
 # CONFIG_PPC_EARLY_DEBUG is not set
 CONFIG_PPC_FSL_BOOK3E=y
 CONFIG_PPC_INDIRECT_PCI=y
+CONFIG_PPC_LIB_RHEAP=y
 CONFIG_PPC_MMU_NOHASH=y
 CONFIG_PPC_PAGE_SHIFT=12
 # CONFIG_PPC_QEMU_E500 is not set
@@ -230,12 +266,15 @@ CONFIG_SPE=y
 CONFIG_SPE_POSSIBLE=y
 CONFIG_SPI=y
 CONFIG_SPI_FSL_ESPI=y
+CONFIG_SPI_FSL_LIB=y
 CONFIG_SPI_MASTER=y
 CONFIG_SPI_MEM=y
 CONFIG_SRCU=y
 # CONFIG_STRIP_ASM_SYMS is not set
 # CONFIG_STX_GP3 is not set
 CONFIG_SWPHY=y
+CONFIG_MICREL_PHY=y
+CONFIG_AT803X_PHY=y
 CONFIG_SYSCTL_EXCEPTION_TRACE=y
 CONFIG_TARGET_CPU="8540"
 CONFIG_TARGET_CPU_BOOL=y
@@ -256,6 +295,14 @@ CONFIG_UCC=y
 CONFIG_UCC_FAST=y
 CONFIG_UCC_GETH=y
 # CONFIG_UGETH_TX_ON_DEMAND is not set
+CONFIG_USB=y
+CONFIG_USB_COMMON=y
+CONFIG_USB_EHCI_FSL=y
+CONFIG_USB_EHCI_HCD=y
+# CONFIG_USB_EHCI_HCD_PLATFORM is not set
+CONFIG_USB_EHCI_HCD_PPC_OF=y
+CONFIG_USB_FHCI_HCD=y
+CONFIG_FHCI_DEBUG=n
 CONFIG_USB_SUPPORT=y
 CONFIG_VDSO32=y
 # CONFIG_VIRT_CPU_ACCOUNTING_NATIVE is not set
@@ -266,3 +313,10 @@ CONFIG_WATCHDOG_CORE=y
 # CONFIG_XES_MPC85xx is not set
 CONFIG_XZ_DEC_BCJ=y
 CONFIG_XZ_DEC_POWERPC=y
+# CONFIG_FB_FSL_DIU is not set
+# CONFIG_VGA_CONSOLE is not set
+CONFIG_USB_STORAGE=y
+CONFIG_USB_UAS=y
+CONFIG_SCSI=y
+CONFIG_BLK_DEV_SD=y
+CONFIG_MTD_NAND_ECC_SW_BCH=y
diff --git a/target/linux/mpc85xx/image/p2020.mk b/target/linux/mpc85xx/image/p2020.mk
index 79b5fa660c..e6ef38ff18 100644
--- a/target/linux/mpc85xx/image/p2020.mk
+++ b/target/linux/mpc85xx/image/p2020.mk
@@ -13,3 +13,12 @@ define Device/freescale_p2020rdb
 	pad-rootfs $$(BLOCKSIZE) | append-metadata
 endef
 TARGET_DEVICES += freescale_p2020rdb
+
+define Device/cznic_turris1x
+  DEVICE_VENDOR := CZ.NIC
+  DEVICE_MODEL := Turris 1.x
+  DEVICE_PACKAGES :=  \
+    kmod-hwmon-core kmod-hwmon-lm90 kmod-usb3 kmod-rtc-ds1307 kmod-crypto-hw-talitos kmod-leds-turris-1x
+  KERNEL = kernel-bin
+endef
+TARGET_DEVICES += cznic_turris1x
diff --git a/target/linux/mpc85xx/p2020/config-default b/target/linux/mpc85xx/p2020/config-default
index 22ab9036c7..ef32280dac 100644
--- a/target/linux/mpc85xx/p2020/config-default
+++ b/target/linux/mpc85xx/p2020/config-default
@@ -27,3 +27,30 @@ CONFIG_SOCK_RX_QUEUE_MAPPING=y
 CONFIG_TREE_RCU=y
 CONFIG_TREE_SRCU=y
 CONFIG_XPS=y
+CONFIG_I2C=y
+CONFIG_I2C_BOARDINFO=y
+CONFIG_I2C_CHARDEV=y
+CONFIG_I2C_MPC=y
+CONFIG_MTD_UBI=y
+CONFIG_MTD_UBI_BEB_LIMIT=20
+# CONFIG_MTD_UBI_BLOCK is not set
+# CONFIG_MTD_UBI_FASTMAP is not set
+# CONFIG_MTD_UBI_GLUEBI is not set
+CONFIG_MTD_UBI_WL_THRESHOLD=4096
+CONFIG_MMC=y
+CONFIG_MMC_BLOCK=y
+CONFIG_MMC_SDHCI=y
+CONFIG_MMC_SDHCI_IO_ACCESSORS=y
+CONFIG_MMC_SDHCI_OF_ESDHC=y
+# CONFIG_MMC_SDHCI_PCI is not set
+CONFIG_MMC_SDHCI_PLTFM=y
+# CONFIG_MMC_TIFM_SD is not set
+# CONFIG_MMC_WBSD is not set
+CONFIG_NET_DSA_QCA8K=y
+CONFIG_UBIFS_FS=y
+CONFIG_UBIFS_FS_ADVANCED_COMPR=y
+CONFIG_UBIFS_FS_LZO=y
+CONFIG_UBIFS_FS_XZ=y
+CONFIG_UBIFS_FS_ZLIB=y
+CONFIG_RTC_NVMEM=y
+CONFIG_NVMEM_SYSFS=y
--
2.34.1

