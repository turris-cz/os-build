From 43d7e87a1c7de64f2c2a98a8eabdbd0a02ef65f4 Mon Sep 17 00:00:00 2001
From: Michal Hrusecky <michal.hrusecky@turris.com>
Date: Wed, 6 Mar 2024 10:20:09 +0100
Subject: [PATCH 2/2] target/linux: Rebase broken patch

---
 ...k-add-pcs_enable-pcs_disable-methods.patch | 30 +++++++++++--------
 1 file changed, 17 insertions(+), 13 deletions(-)

diff --git a/target/linux/generic/backport-5.15/792-03-v6.6-net-phylink-add-pcs_enable-pcs_disable-methods.patch b/target/linux/generic/backport-5.15/792-03-v6.6-net-phylink-add-pcs_enable-pcs_disable-methods.patch
index 71b09cbe75..0ed3cd6299 100644
--- a/target/linux/generic/backport-5.15/792-03-v6.6-net-phylink-add-pcs_enable-pcs_disable-methods.patch
+++ b/target/linux/generic/backport-5.15/792-03-v6.6-net-phylink-add-pcs_enable-pcs_disable-methods.patch
@@ -14,8 +14,10 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  include/linux/phylink.h   | 16 +++++++++++++
  2 files changed, 55 insertions(+), 9 deletions(-)
 
---- a/drivers/net/phy/phylink.c
-+++ b/drivers/net/phy/phylink.c
+Index: linux-5.15.148/drivers/net/phy/phylink.c
+===================================================================
+--- linux-5.15.148.orig/drivers/net/phy/phylink.c
++++ linux-5.15.148/drivers/net/phy/phylink.c
 @@ -34,6 +34,10 @@ enum {
  	PHYLINK_DISABLE_STOPPED,
  	PHYLINK_DISABLE_LINK,
@@ -35,7 +37,7 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  
  	bool mac_link_dropped;
  	bool using_mac_select_pcs;
-@@ -798,6 +803,22 @@ static void phylink_mac_pcs_an_restart(s
+@@ -809,6 +814,22 @@ static void phylink_mac_pcs_an_restart(s
  	}
  }
  
@@ -58,7 +60,7 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  static void phylink_major_config(struct phylink *pl, bool restart,
  				  const struct phylink_link_state *state)
  {
-@@ -835,12 +856,16 @@ static void phylink_major_config(struct
+@@ -846,12 +867,16 @@ static void phylink_major_config(struct
  	 * for the change.
  	 */
  	if (pcs_changed) {
@@ -75,7 +77,7 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  	if (pl->pcs_ops) {
  		err = pl->pcs_ops->pcs_config(pl->pcs, pl->cur_link_an_mode,
  					      state->interface,
-@@ -1264,6 +1289,7 @@ struct phylink *phylink_create(struct ph
+@@ -1281,6 +1306,7 @@ struct phylink *phylink_create(struct ph
  	pl->link_config.speed = SPEED_UNKNOWN;
  	pl->link_config.duplex = DUPLEX_UNKNOWN;
  	pl->link_config.an_enabled = true;
@@ -83,7 +85,7 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  	pl->mac_ops = mac_ops;
  	__set_bit(PHYLINK_DISABLE_STOPPED, &pl->phylink_disable_state);
  	timer_setup(&pl->link_poll, phylink_fixed_poll, 0);
-@@ -1655,6 +1681,8 @@ void phylink_start(struct phylink *pl)
+@@ -1672,6 +1698,8 @@ void phylink_start(struct phylink *pl)
  	if (pl->netdev)
  		netif_carrier_off(pl->netdev);
  
@@ -92,16 +94,16 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  	/* Apply the link configuration to the MAC when starting. This allows
  	 * a fixed-link to start with the correct parameters, and also
  	 * ensures that we set the appropriate advertisement for Serdes links.
-@@ -1665,6 +1693,8 @@ void phylink_start(struct phylink *pl)
+@@ -1682,6 +1710,8 @@ void phylink_start(struct phylink *pl)
  	 */
  	phylink_mac_initial_config(pl, true);
  
 +	pl->pcs_state = PCS_STATE_STARTED;
 +
- 	clear_bit(PHYLINK_DISABLE_STOPPED, &pl->phylink_disable_state);
- 	phylink_run_resolve(pl);
+ 	phylink_enable_and_run_resolve(pl, PHYLINK_DISABLE_STOPPED);
  
-@@ -1684,16 +1714,9 @@ void phylink_start(struct phylink *pl)
+ 	if (pl->cfg_link_an_mode == MLO_AN_FIXED && pl->link_gpio) {
+@@ -1700,16 +1730,9 @@ void phylink_start(struct phylink *pl)
  			poll = true;
  	}
  
@@ -120,7 +122,7 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  	if (poll)
  		mod_timer(&pl->link_poll, jiffies + HZ);
  	if (pl->phydev)
-@@ -1730,6 +1753,10 @@ void phylink_stop(struct phylink *pl)
+@@ -1746,6 +1769,10 @@ void phylink_stop(struct phylink *pl)
  	}
  
  	phylink_run_resolve_and_disable(pl, PHYLINK_DISABLE_STOPPED);
@@ -131,8 +133,10 @@ Signed-off-by: David S. Miller <davem@davemloft.net>
  }
  EXPORT_SYMBOL_GPL(phylink_stop);
  
---- a/include/linux/phylink.h
-+++ b/include/linux/phylink.h
+Index: linux-5.15.148/include/linux/phylink.h
+===================================================================
+--- linux-5.15.148.orig/include/linux/phylink.h
++++ linux-5.15.148/include/linux/phylink.h
 @@ -419,6 +419,8 @@ struct phylink_pcs {
  /**
   * struct phylink_pcs_ops - MAC PCS operations structure.
-- 
2.44.0

